# Папка `/protocol/`

## Назначение

Папка `/protocol/` реализует протокол WebSocket (WS). Содержит компоненты парсинга и формирования WebSocket-фреймов с zero-copy support, а также основную логику работы WebSocket-соединения, совместимую с pooling-архитектурой и многопоточностью.

## Содержимое и структура

- **wsframe.go** — структура WebSocket-фрейма, инструменты создания и освобождения zero-copy payload’а.
- **wsconn.go** — реализация соединения WebSocket поверх сетевого транспорта (`NetConn`). Управляет чтением и записью фреймов, работой с pool'ом.

### Функциональные компоненты

#### WebSocketFrame

- Поля:
  - `Header []byte`: хранит заголовок WebSocket-кадра.
  - `Payload []byte`: полезная нагрузка (выделяется пулом, zero-copy).
  - `PoolRef BytePool`: ссылка на object pool, владеющий памятью payload'а.
- Методы:
  - `NewWebSocketFrame(pool, payload)`: создаёт фрейм с использованием пула.
  - `Release()`: возвращает payload обратно в byte pool, предотвращая нагрузку на GC.

#### WebSocketConn

- Объединяет потоковое сетевое соединение с pool-backed буферизацией.
- В реализациях используются zero-copy операции: чтение буфера из пула, обработка, возврат.
- Методы:
  - `ReadFrame()`: читает данные из сетевого соединения, формирует WebSocketFrame, управляет жизненным циклом буфера.
  - `WriteFrame()`: отправляет фрейм, освобождая ресурсы после успешной отправки.
  - `Close()`: завершает работу соединения.

### Особенности реализации

- Работа с pool'ом позволяет избежать избыточных аллокаций и нагрузок на GC при массовой обработке сообщений.
- Архитектура полностью совместима с техническими требованиями zero-copy (в перспективе интеграция sendfile/io_uring).
- Поддержка NUMA-aware пула — каждый обработчик может иметь собственный byte pool для минимизации латентности.

## Связь с другими слоями

- Использует pool-реализации из `/pool/` и интерфейсы из `/api/`.
- Взаимодействует с транспортом `/transport/` для доступа к физическим данным сокета.

## Экстенсивность

- Модули легко расширяются до поддержки продвинутых WebSocket-расширений, например, компрессии, ping/pong, фрейминга по стандарту RFC6455.
- В архитектуре оставлены точки расширения для offload-нагрузок, batching, обработки потока фреймов (pipeline).

## Тестируемость

- Все методы легко покрываются модульными тестами с использованием фейковых пулов и транспортов (`/fake/`).
- Предусмотрена возможность интеграционного тестирования на "сырых" TCP-соединениях.

## Назначение для практики

- Слой `/protocol/` выделяет всю логику парсинга/серилизации WebSocket в отдельный уровень, облегчая поддержку и модернизацию всего проекта.
