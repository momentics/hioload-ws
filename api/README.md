# Папка `/api/`

## Назначение

Директория `/api/` содержит публичные интерфейсы, определяющие контракты между слоями архитектуры библиотеки WebSocket. Эти интерфейсы обеспечивают слабую связанность между компонентами, гарантируют возможность подстановки различных реализаций (в том числе моков и production-реализаций), и служат основой для clean-архитектуры системы.

## Описание интерфейсов

### Reactor

Интерфейс `Reactor` представляет собой абстракцию над event loop, предназначенную для гибкой интеграции с различными механизмами обработки событий, включая:

- epoll (Linux)
- io_uring (Linux >=5.11)
- kqueue (BSD, macOS)
- IOCP (Windows)

#### Методы:
- `Run(ctx context.Context) error`: Запускает главный loop реактора для управления сетевыми соединениями.
- `Register(conn NetConn) error`: Добавляет сетевое соединение в реактор для дальнейшей обработки событий ввода/вывода.

### NetConn

Абстракция сетевого соединения. Интерфейс инкапсулирует низкоуровневую работу с сетевыми дескрипторами/сокетами.

#### Методы:
- `Read(buf []byte) (int, error)`: Считывает данные из соединения в предоставленный буфер.
- `Write(buf []byte) (int, error)`: Отправляет данные по соединению.
- `Close() error`: Закрывает соединение.

### BytePool

Интерфейс для управления пулами байтовых буферов — фундамент для реализации zero-copy подхода.

#### Методы:
- `Get() []byte`: Возвращает готовый буфер.
- `Put([]byte)`: Освобождает буфер и возвращает его в пул.

### ObjectPool[T any]

Обобщённый object pool для включения кэширования любых типов объектов.

#### Методы:
- `Get() T`: Получает объект из пула.
- `Put(T)`: Возвращает объект обратно в пул.

### NumaPoolManager

Интерфейс управления пуллами с разбиением по NUMA-нодам или CPU. Используется для достижения NUMA-awareness и уменьшения задержек за счёт оптимизации локальности памяти.

#### Методы:
- `PoolForNode(nodeID int) ObjectPool[T]`: Возвращает пул для заданной NUMA-ноды.
- `PoolForCPU(cpuID int) ObjectPool[T]`: Возвращает пул для заданного логического ядра.

### WebSocketConn

Контракт WebSocket-соединения. Представляет архитектурный слой над raw соединением и подразумевает полную или частичную реализацию протокола WebSocket.

#### Методы:
- `ReadFrame() (*WebSocketFrame, error)`: Чтение одного WebSocket-фрейма.
- `WriteFrame(*WebSocketFrame) error`: Отправка одного WebSocket-фрейма.
- `Close() error`: Закрытие соединения.

### WebSocketFrame

Структура, представляющая WebSocket frame. Все буферы являются zero-copy и передаются через byte pool.

#### Поля:
- `Header []byte`: Заголовок WebSocket.
- `Payload []byte`: Полезные данные (zero-copy).
- `PoolRef BytePool`: Ссылка на объект-пул, владеющий буфером.

#### Метод:
- `Release()`: Возврат payload в исходный пул.

## Архитектурная роль

Интерфейсы из `/api/` служат единственным источником общения между разными логическими слоями библиотеки (`reactor`, `transport`, `protocol`). Это обеспечивает гибкость, возможность расширения, заменяемость и высокую тестируемость.

## Связь с остальной системой

- **Reactor** взаимодействует с **NetConn**
- **NetConn** использует **BytePool**
- **WebSocketConn** использует **WebSocketFrame**, который в свою очередь использует **BytePool**
- Пулы управляются через **NumaPoolManager**

## Статус

Интерфейсы стабильны, покрыты тестами через `fake`-пакеты. Можно расширять при необходимости.
