# Пакет `/api/`

---

## Общее описание

Папка `/api/` содержит фундаментальные низкоуровневые и абстрактные интерфейсы и контракты, предназначенные для построения высоконагруженных, кроссплатформенных серверов и библиотек, ориентированных на транспорт реального времени, включая поддержку WebSocket и других протоколов поверх TCP, UDP и shared-memory.

Архитектура следует концепциям `clean architecture`, принципам `highload design`, асинхронному программированию, `zero-copy`, `poll-mode`, `NUMA-awareness` и использует адаптированные практики на базе подходов `DPDK`, RDMA и OS-bypass.

Все интерфейсы спроектированы с учетом следующих требований:

- максимально возможная производительность;
- кроссплатформенность (Linux 6.2+, Windows Server 2016+);
- точечное управление CPU affinity / NUMA / memory layout;
- тестируемость, мокаемость, масштабируемость;
- строгая контрактность и масштабируемость.

---

## Содержимое папки `/api/`

| Файл             | Назначение                                                                 |
|------------------|------------------------------------------------------------------------------|
| `transport.go`   | Интерфейсы для высокоскоростного транспорта данных                         |
| `poll.go`        | Интерфейс для реализации poll-mode (DPDK-like reactor loop)                 |
| `batching.go`    | Обобщённый интерфейс для работы с батчами                                    |
| `buffer.go`      | Интерфейсы буферов, позволяющие реализовывать zero-copy / sliceable memory  |
| `affinity.go`    | Интерфейсы для CPU pinning и NUMA-aware выполнения                          |
| `context.go`     | Расширяемый контекст выполнения с типизированным доступом к значениям       |
| `result.go`      | Общий механизм для возврата результатов с ошибками и отменой                |
| `handler.go`     | Абстракция обработчика событий / batch / событий                            |
| `ring.go`        | Контракт для lock-free кольцевого буфера                                     |
| `control.go`     | Интерфейс управления конфигурацией и статистикой во время выполнения         |
| `testing.go`     | Мокаемые реализации ключевых компонентов для тестов                         |

Будущие версии могут добавить:

- TimeScheduler/Engine API (по аналогии с netpoll)
- Интерфейсы traceroute/debug/telemetry
- Специализированные EventLoop/Executor интерфейсы
- Расширения под WASM

---

## Подробности по каждому компоненту

### 1. `transport.go`

Определяет главный интерфейс для транспорта данных. Поддерживает zero-copy, батчинг, NUMA-информированные передачи, шину памяти и традиционные сетевые адаптеры.

**Основные интерфейсы:**

- `Transport`: основной интерфейс для отправки и получения данных.
- `TransportFeatures`: структура, описывающая особенности транспорта (zero-copy, batching и т.д.).

**Ключевые свойства:**

- Данные принимаются/отдаются в виде срезов буферов (`[][]byte`);
- Абстрагирован от конкретных реализаций: TCP, UDP, RDMA, SHM, mmap и других;
- Подходит для замены даже в процессе выполнения (hot-swap).

---

### 2. `poll.go`

Формализует интерфейс паттерна `poll-loop`, применяемого вместо прерываний для уменьшения латентности. Аналог механизма обработки `event loop` в DPDK и NAPI.

**Основной интерфейс:**

- `Poller`: интерфейс обработки входящих событий за один проход poll-цикла.

**Ключевые методы:**

- `Poll(maxEvents int)`: активный цикл обработки с ограничением на количество событий;
- `Register() / Unregister()`: управление списком активных хендлеров.

---

### 3. `batching.go`

Обобщённая модель батчей/пакетов. Батч не зависит от типов.

**Основной интерфейс:**

- `Batch[T any]`: универсальный интерфейс батча с методами доступа/среза.

**Применение:**

- Передача сообщений в Transport;
- Массовая обработка в Poller'ах;
- Минимизация аллокаций и системных вызовов.

---

### 4. `buffer.go`

Определяет интерфейс буферов, поддерживающих zero-copy и sliceable/segmentable память.

**Основные интерфейсы:**

- `Buffer`: отдельный сегмент памяти с методом `Slice`, `Bytes()`, `Release()`.
- `BufferPool`: пул буферов, реализующий перераспределяемость и экономию на GC.

**Примечания:**

- Интегрируемо с системной hugepages / mmap / shared memory;
- Поддерживает выделение памяти вне GC/heap.

---

### 5. `affinity.go`

Механизм управления привязкой потоков и горутин к CPU и NUMA узлам.

**Основной интерфейс:**

- `Affinity`

**Функциональность:**

- Явная привязка текущего потока исполнения (`Pin`, `Unpin`);
- Query текущего NUMA/CPU (`Get()`);
- Используется в конвейере, шедулерах и event loop.

---

### 6. `context.go`

Общий, но безопасный механизм хранения значений и объектов, которые передаются через границы слоёв системы.

**Основной интерфейс:**

- `Context` — универсальный словарь значений с типами.

**Особенности реализации:**

- Полная отделенность от стандартного `context.Context`;
- Поддержка `Set`, `Get`, `Delete`;
- Подходит для применений специфических фич (например, trace, priority).

---

### 7. `result.go`

Стандартный подход для оборачивания результата выполнения (успех + ошибка) и отмены.

**Основные конструкции:**

- `Result[T any]`: параметризованный результат;
- `Cancelable`: объект, выполняющий поддерживаемую отмену (`Cancel`, `Done`, `Err()`).

**Применение:**

- Возврат результата из async интерфейсов;
- Middleware/handler-deferring;
- Интеграция с scheduler/task-фреймворками.

---

### 8. `handler.go`

Обобщённый однотипный обработчик событий, сообщений, батчей или других данных.

**Основной интерфейс:**

- `Handler`: контракт метода `Handle(data any) error`.

**Применение:**

- Привязка к `Poller`;
- Обработка элементов в Ring;
- Реализация Middleware через обёртки `Handler`.

---

### 9. `ring.go`

Классическая расширяемая реализация lock-free структуры FIFO: кольцевой буфер.

**Основной интерфейс:**

- `Ring[T any]`: параметризованная очередь, безопасная для конкурентного использования.

**Основные операции:**

- `Enqueue`, `Dequeue`;
- `Len()/Cap()` — полезно для контролирования нагрузки;
- Используется для thread-pinning, моторного обмена между процессами и кастомных очередей.

---

### 10. `control.go`

Абстракция слоя управления настройками, внутренним состоянием и метриками.

**Основной интерфейс:**

- `Control`: API управления конфигурацией, статистика, возможность hot-reload.

**Методы:**

- `GetConfig() / SetConfig()` — получение/обновление конфигураций;
- `Stats()` — возврат текущей метрики как `map[string]any`;
- `OnReload()` — API перезагрузки/горячего обновления.

---

### 11. `testing.go`

Модуль содержит моки и вспомогательные реализации для юнит-тестирования любых компонентов /api.

**Основной интерфейс/структура:**

- `MockTransport`: полная мокаемая реализация транспорта;
- Методы: `SendFunc`, `RecvFunc`, `CloseFunc`, `FeaturesFunc`.

**Расширяемость:**

- Возможность добавления моков для всех интерфейсов из пакета `/api`;
- Используется в пакетах `*_test.go` во всех модулях.

---
