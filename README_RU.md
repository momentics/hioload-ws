# hioload-ws

Высокопроизводительный, NUMA-aware, Zero-Copy каркас библиотеки WebSocket на Golang

---

## Оглавление

- [Общие сведения](#общие-сведения)
- [Функциональные возможности](#функциональные-возможности)
- [Архитектура проекта](#архитектура-проекта)
- [Структура каталогов](#структура-каталогов)
- [Описания основных директорий](#описания-основных-директорий)
- [Описание ключевых компонентов](#описание-ключевых-компонентов)
  - [Публичные интерфейсы и API](#публичные-интерфейсы-и-api)
  - [Реактор и NUMA-осведомлённость](#реактор-и-numa-осведомлённость)
  - [Менеджмент буферов и Object Pool](#менеджмент-буферов-и-object-pool)
  - [Транспортный слой](#транспортный-слой)
  - [Протокол WebSocket](#протокол-websocket)
  - [Fake/Mock реализации и тестирование](#fakemock-реализации-и-тестирование)
  - [Примеры и запуск](#примеры-и-запуск)
- [Инструкции по установке и запуску](#инструкции-по-установке-и-запуску)
    - [Системные требования](#системные-требования)
    - [Загрузка исходного кода](#загрузка-исходного-кода)
    - [Сборка и запуск](#сборка-и-запуск)
    - [Тестирование](#тестирование)
    - [Грейсфул-шатдаун (корректное завершение работы)](#грейсфул-шатдаун-корректное-завершение-работы)
- [Особенности архитектуры](#особенности-архитектуры)
- [Интеграция и расширение](#интеграция-и-расширение)
- [Лицензия](#лицензия)
- [Автор](#автор)

---

## Общие сведения

`hioload-ws` — каркас библиотеки для разработки серверов WebSocket, оптимизированный под сверх высокие нагрузки на базе языка Golang с опорой на современные отраслевые стандарты (DPDK-best-practice), NUMA-архитектуры, zero-copy, асинхронный poll-mode IO и продвинутые механизмы работы с памятью и многопоточностью.

Вся архитектура ориентирована на минимизацию задержек, максимизацию пропускной способности, поддержку максимально масштабируемых сценариев рабочих нагрузок (от десятков тысяч до миллионов соединений на сервер), а также легкость интеграции с инфраструктурными средствами (affinity, batching, huge pages и др.).

Библиотека построена по принципам чистой архитектуры, требует минимум внешних зависимостей, активно использует интерфейсы, покрывается модульными и интеграционными тестами, документы и код снабжены обширными комментариями на английском языке.

---

## Функциональные возможности

- Работа в режиме poll-mode (epoll/io_uring/IOCP-ready).
- NUMA-aware object/byte pool-менеджмент.
- Полная модель Zero-Copy (при поддержке платформы).
- Чисто-слойная архитектура, пригодная для расширения.
- Многопоточные lock-free/wait-free структуры.
- Реализация batching, prefetch, поддержка CPU affinity.
- Простая интеграция с io_uring, DPDK, sendfile, hugepages.
- Интегрированные mock- и fake-слои для ускорения тестирования и внедрения в CI.
- Сопровождающая документация и комментарии по всем исходникам.

---

## Архитектура проекта

Среда построена по принципам Clean Architecture и строгой разделённости областей ответственности. Каждый каталог реализует строго определенный слой логики, а взаимодействие между слоями регулируется через понятные и устойчивые контракты (интерфейсы):

- **api/** — публичные интерфейсы.
- **reactor/** — реактор: event loop, poller, NUMA-aware схемы.
- **pool/** — memory/object/byte pool’ы.
- **transport/** — сетевой слой, работающий с pool-backed буферами.
- **protocol/** — логика протокола WebSocket, разбор фреймов, zero-copy.
- **fake/** — моки, fake/replacement реализации для тестов и CI.
- **examples/** — работающие примеры (например, echo-сервер).

Реальная рабочая нагрузка разделяется между слоями благодаря системе инъекций зависимостей, эффективному использованию Go-интерфейсов, внедрению unit- и integration-тестов.

---

## Структура каталогов

| Каталог      | Назначение                                                                                 |
|--------------|-------------------------------------------------------------------------------------------|
| `/api/`      | Все публичные интерфейсы: Reactor, Pool, NetConn, WSConn                                  |
| `/reactor/`  | Реакторы, event-loop, NUMA logic, poll-mode процессы                                      |
| `/pool/`     | Буферные и объектные пулы (thread-, NUMA-aware)                                           |
| `/transport/`| Сетевой транспорт + интеграция pool-backed буферов                                        |
| `/protocol/` | Парсер WebSocket фреймов и абстракции уровня WS                                           |
| `/fake/`     | Моки, fake и stub-реализации для тестирования и CI                                        |
| `/examples/` | Пример приложений на основе этого каркаса (echo server и др.)                             |
| `README.md`  | Основная справка на английском                                                             |
| `README_RU.md` | Полная русскоязычная версия документации проекта                                        |
| `go.mod`     | Модульный файл Go, определяющий зависимость и версию языка                                |

---

## Описания основных директорий

### `/api/` — публичные интерфейсы (Reactor, Pool, WSConn)

Содержит контракты всех ключевых слоёв архитектуры, задающие правила взаимодействия между event loop, транспортом, менеджментом памяти и WebSocket-уровнем. Гарантируется единое API для всех реализаций, тестируемость, возможность подмены реализаций без переписывания бизнес-логики.

---

### `/reactor/` — event-loop, NUMA-aware, poll-mode

Содержит утилиты и каркасы реализации реакторов: event loop на базе poll-mode (epoll, io_uring, IOCP etc.), NUMA-aware, возможность pinning потоков к ядрам и NUMA node для сокращения задержек и увеличения throughput. Расширяется до продвинутых высоконагруженных реализаций.

---

### `/pool/` — объектные и байтовые пулы

Инкапсуляция object pool для любых структур и byte pool для управления буферами. Предусмотрены thread-local, NUMA-segmented варианты (реальными и mock). Все обращения к памяти проходят через эти пулы, что позволяет обеспечивать zero-copy, эффективное использование кэша и устранение избыточных аллокаций/GC overhead.

---

### `/transport/` — транспортные абстракции

Сетевой backend с поддержкой zero-copy буферов. Интегрирует bytepool, абстрагирует от источника данных (стандартный net.Conn, io_uring, userspace stack, в дальнейшем — DPDK/XDP-бэкенды). Возможность прямой замены без изменения бизнес-логики наверху.

---

### `/protocol/` — протокол WebSocket

Комплексная обработка логики фреймов WebSocket поверх транспортного уровня. Поддержка zero-copy payload, pooling, оффлоад операций, batch-propagation обработки сообщений, управляемый lifecycle всех ресурсов. Код интенсивно комментирован, пригоден для расширения.

---

### `/fake/` — Fake/Mock объекты

Тестовые/замещающие реализации всех основных интерфейсов. Используется для практичного unit/integration тестирования как снаружи, так и во внутреннем CI/CD пайплайне. Позволяет писать нагрузочные и крайние тесты вне зависимости от реального backend-слоя.

---

### `/examples/` — примеры запуска

Рабочие примеры приложений, написанных на базе библиотеки: минималистичные server, echo-сервг и т.п. Демонстрируют принципы сборки, интеграции слоёв и основы эффективной работы с каркасом.

---

## Описание ключевых компонентов

### Публичные интерфейсы и API

Документированные интерфейсы для управления соединениями, буферами, event loop. Контракты тщательно проработаны: поддерживается экстремальное масштабирование пула, безопасная передача владения объектами и буферами, готовность к zero-copy и NUMA-aware операциям.

- Reactor — event loop, общий контракт для poller’ов и io_uring.
- NetConn — инкапсуляция потокового соединения, совместимая с любыми backends.
- BytePool, ObjectPool — управление буферами и любыми параллельно-используемыми структурами.
- NumaPoolManager — менджер типа per-node — для affinity- и locality-операций.
- WebSocketConn/Frame — полный контракт работы с кадрами и WS соединениями.

---

### Реактор и NUMA-aware

Реализация event loop изначально представлена заглушкой; поддерживаются фейки для лёгкой подмены/тестирования любых сценариев. В развёрнутом варианте сюда добавляется NUMA-aware второй уровень, обеспечивающий привязку reactor’ов и handler’ов к физическим ядрам и NUMA node для поддержки масштабирования нагрузки и минимизации overhead кэша.

---

### Менеджмент буферов и Object Pool

Главная задача — создать надёжный инструмент управления буферами (byte pool), который:

- Избавляет от необходимости частых аллокаций.
- Сокращает количество обращений к GC.
- Ускоряет повторное использование памяти между потоками.
- Учитывает NUMA и CPU-locality, разделяя pool'ы между node/CPU (перспективно — полная NUMA-aware архитектура).
- Позволяет реализовать полностью zero-copy и zero-GC-паттерны для hottest path.
- Легко интегрируется в любой высоконагруженный цикл (над io_uring, DPDK и др.).

---

### Транспортный слой

Слой, осуществляющий низкоуровневую передачу/приём данных с поддержкой object pool и возможность zero-copy (выделение буфера под чтение не на стеке, а снаружи/из pool). Предполагается масштабироваться вплоть до использования Linux io_uring или сторонних NIC (DPDK).

---

### Протокол WebSocket

Реализован на верхнем уровне как набор структур и методов по работе с фреймами WebSocket, управление чтением/записью с пользованием pool. Буферы payload непосредственно получаются из byte pool и живут ровно столько, сколько необходимо для передачи данных, далее возвращаясь в пул через Release.

Поддерживается полная zero-copy модель: данные не копируются между слоями, что особенно принципиально для massive load-решений.

---

### Fake/Mock реализации и тестирование

Дополняет остальные слои возможностью подмены реальных компонент на stub-реализации для целей тестирования, CI, бенчмаркинга, разработки функциональных/нагрузочных тестов без запуска настоящей heavy-инфраструктуры.

---

### Примеры и запуск

В директории `/examples/` представлен готовый сервер echo WebSocket на базе fake reactor и byte pool. Сервер демонстрирует ключевые концепции архитектуры — чтение и отправку данных с минимальными издержками, zero-copy, возврат буферов, контроль времени жизни payload.

Любое сообщение, поступившее на сервер, возвращается обратно в исходном виде c помощью наиболее быстрых операций над memory pool.

---

## Инструкции по установке и запуску

### Системные требования

- Golang версии 1.21 и выше.
- Linux (ядро 6.20 и новее) либо Microsoft Windows Server 2016+.
- Поддержка UTF-8 консоли, стандартных сетевых операций.
- Свободный доступ к внешнему интернету для загрузки зависимостей Go.
- Доступ к терминалу и базовые инструменты командной строки.

---

### Загрузка исходного кода

```

git clone https://github.com/momentics/hioload-ws.git
cd hioload-ws

```

Весь исходный код хранится в открытом доступе. Все файлы находятся по структуре, описанной в README.

---

### Сборка и запуск

#### Проверка структуры

Файлы `go.mod`, `README.md`, `README_RU.md`, каталоги `api/`, `transport/`, `pool/`, `examples/` и остальные должны быть на месте.

#### Скачивание зависимостей (опционально):

```

go mod tidy

```

В базе — внешний зависимостей нет. При расширении могут появиться дополнительные строки.

#### Запуск примера echo-сервера:

```

go run ./examples/echo/main.go

```

При запуске сервера в консоли появляется сообщение:

```

Echo WebSocket server started on :9001...

```

Сервер будет слушать входящие TCP-соединения на порту 9001, принимая и возвращая все присланные сообщения клиенту.

---

### Тестирование

Для запуска модульных тестов по всему проекту:

```

go test ./...

```

Тесты анализируют работоспособность mock-объектов, а также корректность pool-архитектуры и transport-уровня.

---

### Грейсфул-шатдаун (корректное завершение работы)

Для завершения echo-сервера требуется нажать `Ctrl+C` либо отправить процессу SIGINT. Сервер корректно завершает обработку текущих соединений и освобождает ресурсы.

---

## Особенности архитектуры

- Полностью реализована разделённость слоёв (чистая архитектура), все интерфейсы рассчитаны на подменяемость и долговременную поддержку.
- Поддержка zero-copy по всей длине данных — от входного стека до WebSocket-уровня.
- Механизм object/byte pool-ов поддерживает NUMA-aware сценарии с минимальным оверхедом.
- Готовность для внедрения io_uring, DPDK, batching, offload, huge pages, pinning worker’ов к CPU/NUMA.
- Кроссплатформенность, поддержка современных реалий Linux, Windows Server.
- Высокий стандарт надёжности, тестируемости — максимально полный coverage моки и unit-тесты.

---

## Интеграция и расширение

- Замена fake pool/реактора выполняется без изменения логики более высоких слоёв.
- Подключаемые модули совместимы с любыми production-ready бэкендами (реальный reactor, продвинутый object pool, affinity- и batch-менеджеры).
- Возможна дальнейшая интеграция с внешними метриками, средствами мониторинга, анализаторами производительности без изменения пользовательского API.

---

## Лицензия

MIT License. Все детали приводятся в LICENSE. Проект открыт для обсуждения, форков, pull-request и обсуждения архитектурных решений.

---

## Автор

momentics <momentics@gmail.com>

---

Вся документация и исходные файлы подробно комментированы, соответствуют профессиональным стандартам отрасли и полностью готовы к самостоятельной разработке, модификации, внедрению и промышленной эксплуатации.

Полная техническая справка на английском языке находится в `README.md`.
Русская версия документации — файл `README_RU.md` (именно этот файл).

---
